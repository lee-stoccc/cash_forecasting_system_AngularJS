(function(){angular.module("devplatformApp").controller("HolidayEditController",a);a.$inject=["$rootScope","HolidayService","$scope","$stateParams","$state","ngDialog","PublicService","ngVerify","SysDictService","$uibModalInstance","$translate"];function a(k,j,o,n,b,m,h,e,i,l,c){function f(r,q){i.getDictListAsync(q).then(function(s){if(s.statusCode==="0000"){o[r]=s.data}})}o.init=function(){o.select("#yearHoliday");o.select("#holidayNameHoliday");f("typeList","forecast.holidayType");f("holidayList","forecast.holiday");f("years","forecast.years");d();g()};function g(){var s=Number(h.formatDate(new Date(),"yyyy"));var r=[s];if(o.years.length!==0&&o.years!==undefined){for(var q=0;q<o.years[0].dictDesc;q++){r.push(s+q+1);r.push(s-q-1)}}o.yearArr=r.sort()}o.yearArr=o.yearArr;o.datePickerOpenStatus={};o.select=function(q){angular.element(q).select2({placeholder:c.instant("global.pleaseSelect"),allowClear:true,tags:false})};function d(){if(n.id){o.type="edit";j.getHoliday(n.id).then(function(q){if(q.statusCode==="0000"){o.holiday=q.data;o.dateObj=q.data.details;angular.forEach(o.dateObj,function(u){u.startDate=dateToGMT(u.startDate);u.endDate=dateToGMT(u.endDate)});$("#select2-yearHoliday-container .select2-selection__placeholder").text(o.holiday.year).css("color","#000");var t=o.holiday.holidayNo;for(var r=0;r<o.holidayList.length;r++){if(t==o.holidayList[r]["dictKey"]){var s=o.holidayList[r]["dictDesc"];break}}$("#select2-holidayNameHoliday-container .select2-selection__placeholder").text(s).css("color","#000")}})}}o.dateObj=[{startDate:"",endDate:"",type:""}];o.addDate=function(){o.dateObj.splice(o.dateObj.length+1,0,{startDate:"",endDate:"",type:""})};o.delDate=function(q){if(o.dateObj.length===1){h.showDialogTimeout("holiday.formError.lastOne");return}o.dateObj.splice(q,1)};o.save=function(){if(o.getHoliday()){var q=p();if(!q){h.showDialogTimeout("holiday.formError.dateConflict");return}o.message="global.saveSuccess";o.holiday.details=o.dateObj;var s=o.holiday.details;for(var r=0;r<s.length;r++){if(s[r]["type"]==1){var v=s[r]["endDate"];var t=typeof v;if(t=="object"){var u=v.getTime();o.holiday.details[r]["endDate"]=v.setTime(u+1000*200);var w=s[r]["startDate"];var u=w.getTime();o.holiday.details[r]["startDate"]=w.setTime(u+1000*200)}}else{if(s[r]["type"]==2){var v=s[r]["endDate"];if(typeof v=="object"){var u=v.getTime();o.holiday.details[r]["endDate"]=v.setTime(u+1000*200);var w=s[r]["startDate"];var u=w.getTime();o.holiday.details[r]["startDate"]=w.setTime(u+1000*200)}}}}j.saveHoliday(o.holiday).then(function(x){if(x.statusCode==="0000"){k.$broadcast("rootEventHoliday","holiday");h.openDialog(o.message);o.clear(o.holiday,false)}else{o.message=x.msgCode;h.openDialog(o.message)}})}};o.getHoliday=function(){if(o.holiday.holidayNo==null){h.showDialogTimeout("holiday.formError.chooseHoliday");return false}else{return true}};function p(){var s=true;var r=o.dateObj.length;for(var t=0;t<r;t++){s=o.checkStartTime(t);if(s){if(r-1>t){var q=o.dateObj[t].startDate;var v=o.dateObj[t].endDate;var w=o.dateObj[t+1].startDate;var u=o.dateObj[t+1].endDate;if(q>=w&&q<=u||(q<=w&&v>=w)){s=false;break}}}else{break}}return s}o.openCalendar=function(r,q){var s=r+q;o.datePickerOpenStatus[s]=true};o.checkStartTime=function(u){var r=true;var q=o.dateObj[u].startDate;var w=o.dateObj[u].endDate;o.startDate=q;o.endDate=w;if(q>w&&!h.isEmptyObject(w)){var x="global.timeMsg1";h.openDialog(x);r=false;return}if(u>0){for(var t=1;t<=u;t++){var v=o.dateObj[u-t].startDate;var s=o.dateObj[u-t].endDate;if(q>=v&&q<=s||(q<=v&&w>=v)){h.showDialogTimeout("holiday.formError.startDateConflict");r=false;break}}}return r};o.checkEndTime=function(t){var q=o.dateObj[t].startDate;var v=o.dateObj[t].endDate;o.startDate=q;o.endDate=v;if(q>v&&!h.isEmptyObject(q)){var w="global.timeMsg2";h.openDialog(w);return}if(t>0){for(var s=1;s<=t;s++){var u=o.dateObj[t-s].startDate;var r=o.dateObj[t-s].endDate;if(v>=u&&v<=r||(q<=u&&v>=r)){h.showDialogTimeout("holiday.formError.endDateConflict")}}}if(o.holiday["year"]!=q.getFullYear()){h.showDialogTimeout("Please Choose The Same Year")}};o.clear=function(r,q){l.close();b.go("app.holiday",r,{reload:false})}}})();