(function(){angular.module("devplatformApp").controller("ForecastPlanEditController",a);a.$inject=["$rootScope","ForecastPlanService","ngDialog","$stateParams","$state","$scope","PublicService","$uibModalInstance","SysDictService"];function a(h,n,i,r,p,j,f,k,o){j.datePickerOpenStatus={};j.forecastPlan={planId:r.planId,termNo:r.termNo,detailList:[{currency:"",denominationList:"",amount:"",count:""}]};j.formParams={planId:r.planId,id:r.id,termNo:r.termNo};var s={};var b;j.typeAndDemination=[{denominationList:[],type:""}];j.init=function(){l("denominationList","forecast.denomination");l("deTypeList","forecast.denomination");c();if(r.planId){n.getForecastPlanDTO(j.formParams).then(function(w){if(w.statusCode==="0000"){j.forecastPlan=w.data;if(f.isEmptyObject(j.forecastPlan.detailList)){c()}for(var x=0;x<j.typeAndDemination.length;x++){if(j.typeAndDemination[x]["type"]=="CNY"){for(var y=0;y<w.data.detailList.length;y++){if(w.data.detailList[y]["currency"]=="CNY"){j.typeAndDemination[x]["denominationList"][0]["count"]=w.data.detailList[y]["count"]}}}else{for(var v=0;v<w.data.detailList.length;v++){if(w.data.detailList[v]["denomination"]==100&&w.data.detailList[v]["currency"]=="HKD"){j.typeAndDemination[x]["denominationList"][0]["count"]=w.data.detailList[v]["count"]}else{if(w.data.detailList[v]["denomination"]==500){j.typeAndDemination[x]["denominationList"][1]["count"]=w.data.detailList[v]["count"]}else{if(w.data.detailList[v]["denomination"]==1000){j.typeAndDemination[x]["denominationList"][2]["count"]=w.data.detailList[v]["count"]}}}}}}j.forecastPlan.replenishDate=dateToGMT(w.data.replenishDate)}})}d(r.bankId);j.changeCurrency("HKD","0");j.add();j.changeCurrency("CNY","1");console.log(j)};function l(w,v){o.getDictListAsync(v).then(function(x){if(x.statusCode==="0000"){j[w]=x.data;b=(x.data).length}})}function d(v){n.getFirstData(v).then(function(w){if(w.statusCode==="0000"){j.stockAmount=w.data.currentStock}})}j.changeCurrency=function(w,v){j.getDenominationList(w,v)};j.getDenominationList=function(x,v){var w="forecast.denomination."+x+"";if(t(x)&&q()>0){f.showDialogTimeout(x+"global.alreadyExisted");return}o.getDictListAsync(w).then(function(y){if(y.statusCode==="0000"){j.typeAndDemination[v]["denominationList"]=y.data;if(j.typeAndDemination[v]["denominationList"].length==1){j.typeAndDemination[v]["type"]="CNY";j.typeAndDemination[v]["denominationList"][0]["dictDescs"]="ï¿¥:"+j.typeAndDemination[v]["denominationList"][0]["dictDesc"]}else{for(var z=0;z<j.typeAndDemination[v]["denominationList"].length;z++){j.typeAndDemination[v]["type"]="HKD";j.typeAndDemination[v]["denominationList"][z]["dictDescs"]="HK$:"+j.typeAndDemination[v]["denominationList"][z]["dictDesc"]}}}});if(x!=""){u(v,x)}else{e(v)}};j.add=function(){if(q()==0){f.showDialogTimeout("global.selectCurrency");return}if(j.typeAndDemination.length>=b){f.showDialogTimeout("global.editDenomination");return}j.typeAndDemination.splice(j.typeAndDemination.length+1,0,{denominationList:[],type:""})};j.del=function(v){if(j.typeAndDemination.length===1){f.showDialogTimeout("global.del");return}e(v);j.typeAndDemination.splice(v,1)};function u(x,v){var w=x;s[w]=v}function q(){var w=0;for(var v in s){w++}return w}function e(v){delete s[v]}function t(w){for(var v in s){if(w==s[v]){return true}}return false}function c(){angular.forEach(j.denominationList,function(v){var w={denomination:v.dictKey};j.forecastPlan.detailList.push(w)})}j.openCalendar=function(v){j.datePickerOpenStatus[v]=true};j.save=function(){m();for(var v=0;v<j.forecastPlan.detailList.length;v++){j.forecastPlan.detailList[0]["currency"]="HKD";j.forecastPlan.detailList[1]["currency"]="HKD";j.forecastPlan.detailList[2]["currency"]="HKD";j.forecastPlan.detailList[3]["currency"]="CNY"}var x=j.forecastPlan.replenishDate;if(typeof x=="object"){var w=x.getTime();j.forecastPlan.replenishDate=x.setTime(w+1000*200)}n.saveForecastPlan(j.forecastPlan).then(function(y){if(y.statusCode==="0000"){j.message="global.saveSuccess";f.showDialogTimeout(j.message);h.$broadcast("forecastPlanEdit","");j.clear(false)}})};j.clear=function(v){k.close();p.go("app.forecastPlan",{},{reload:v})};j.checkDate=function(){if(j.forecastPlan.replenishDate.getDate()<new Date().getDate()){f.openDialog("global.timeMsg3");j.forecastPlan.replenishDate=null}};function m(){var v=new Array();for(var w=0;w<j.typeAndDemination.length;w++){var C=j.typeAndDemination[w].type;var D=j.typeAndDemination[w].denominationList;for(var y=0;y<D.length;y++){var x=Number(D[y].dictKey);var B=Number(D[y].count);var A=x*B;var z={denomination:x,currency:C,count:B,amount:A};v.push(z)}}if(v.length>0){j.forecastPlan.detailList=v}}function g(){var w=0;for(var v=0;v<j.forecastPlan.detailList.length;v++){if(j.forecastPlan.detailList[v].count){w+=j.forecastPlan.detailList[v].denomination*j.forecastPlan.detailList[v].count}else{continue}}if(w>j.stockAmount){return false}return true}}})();