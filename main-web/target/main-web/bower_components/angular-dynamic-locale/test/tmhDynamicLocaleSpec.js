(function(){function a(c){function b(){this.next=[]}b.prototype.done=function(){return this.runs(c)};b.prototype.runs=function(e){var d=new b();this.next.push(function(){e();d.start()});return d};b.prototype.waitsFor=function(f,e,g){var d=new b();g=g||5000;this.next.push(function(){var h=0,i=window.setInterval(function(){if(f()){window.clearInterval(i);d.start()}h+=5;if(h>g){window.clearInterval(i);throw new Error(e)}},5)});return d};b.prototype.start=function(){var d;for(d=0;d<this.next.length;d+=1){this.next[d]()}};return new b()}describe("dynamicLocale",function(){beforeEach(module("tmh.dynamicLocale"));beforeEach(module(function(b){b.localeLocationPattern("/base/node_modules/angular-i18n/angular-locale_{{locale}}.js")}));afterEach(function(b){inject(function(c,d,e){var f=a(b);f.runs(function(){e.set("en-us")}).waitsFor(function(){d.flush(50);return c.id==="en-us"},"locale not reverted",2000).done();f.start()})});it("should (eventually) be able to change the locale",function(b){inject(function(c,d,e){var f=a(b);f.runs(function(){e.set("es")}).waitsFor(function(){d.flush(50);return c.id==="es"},"locale not updated",2000).runs(function(){expect(c.id).toBe("es");expect(c.DATETIME_FORMATS.DAY["0"]).toBe("domingo")}).done();f.start()})});it("should be able to change the locale back-and-forward within one digest",function(b){inject(function(c,d,e,f){var g=a(b);g.runs(function(){c.$apply(function(){f.set("es");f.set("en");f.set("es")})}).waitsFor(function(){e.flush(50);return d.id==="es"},"locale not updated",2000).runs(function(){expect(d.id).toBe("es");expect(d.DATETIME_FORMATS.DAY["0"]).toBe("domingo")}).done();g.start()})});it("should trigger an event when there it changes the locale",function(b){inject(function(e,d,f,c){var h=jasmine.createSpy();var g=a(b);g.runs(function(){c.$apply();c.$on("$localeChangeSuccess",h);f.set("es");expect(h.calls.count()).toBe(0)}).waitsFor(function(){e.flush(50);return d.id==="es"},"locale not updated",2000).runs(function(){expect(h.calls.count()).toBe(1);expect(h.calls.argsFor(0)[1]).toEqual("es");expect(h.calls.argsFor(0)[2]).toEqual(d)}).done();g.start()})});it("should trigger a failure even when the locale change fail",function(b){inject(function(e,d,f,c){var g=a(b);var h=jasmine.createSpy();g.runs(function(){c.$apply();c.$on("$localeChangeError",h);f.set("invalidLocale");expect(h.calls.count()).toBe(0)}).waitsFor(function(){e.flush(50);return h.calls.count()!==0},"error not generated",2000).runs(function(){expect(h.calls.count()).toBe(1);expect(h.calls.argsFor(0)[1]).toEqual("invalidLocale")}).done();g.start()})});it("should return a promise that has the new locale",function(b){inject(function(e,d,f,c){var g=a(b);var h=jasmine.createSpy();g.runs(function(){f.set("es").then(h);expect(h.calls.count()).toBe(0)}).waitsFor(function(){e.flush(50);return h.calls.count()!==0},"locale not updated",2000).runs(function(){expect(h.calls.argsFor(0)[0].id).toEqual("es");expect(h.calls.argsFor(0)[0]).toEqual(d);f.set("it")}).waitsFor(function(){e.flush(50);return d.id==="it"},"locale not updated",2000).runs(function(){f.set("es").then(h);expect(h.calls.count()).toBe(1);c.$apply();expect(h.calls.count()).toBe(2);expect(h.calls.argsFor(1)[0].id).toBe("es");expect(h.calls.argsFor(1)[0]).toBe(d)}).done();g.start()})});it("should reject the returned promise if it fails to load the locale",function(b){inject(function(f,e,g,c){var i=jasmine.createSpy();var d=jasmine.createSpy();var h=a(b);h.runs(function(){g.set("invalidLocale").then(i,d)}).waitsFor(function(){f.flush(50);return d.calls.count()},"promise not rejected",2000).runs(function(){expect(i.calls.count()).toBe(0);expect(d.calls.count()).toBe(1);expect(d.calls.argsFor(0)[0]).toBe("invalidLocale");expect(e.id).toBe("en-us")}).done();h.start()})});it("should be possible to retrieve the locale to be",function(b){inject(function(f,d,g,c,e){var h=a(b);h.runs(function(){g.set("es");expect(g.get()).toBe("es")}).waitsFor(function(){f.flush(50);return d.id==="es"},"locale not updated",2000).runs(function(){expect(g.get()).toBe("es")}).done();h.start()})});it("should revert the configured locale when the new locale does not exist",function(b){inject(function(f,e,g,c){var h=a(b);var d=jasmine.createSpy();h.runs(function(){g.set("es")}).waitsFor(function(){f.flush(50);return e.id==="es"},"locale not updated",2000).runs(function(){g.set("invalidLocale").then(undefined,d);expect(g.get()).toBe("invalidLocale")}).waitsFor(function(){f.flush(50);return d.calls.count()},"promise not rejected",2000).runs(function(){expect(g.get()).toBe("es")}).done();h.start()})});it("should change the already formatted numbers in the page",function(b){inject(function(g,d,h,c,f){var i=a(b);var e=null;i.runs(function(){e=f("<span>{{val | number}}</span>")(c);c.val=1234.5678;c.$apply();expect(e.text()).toBe("1,234.568");h.set("es")}).waitsFor(function(){g.flush(50);return d.id==="es"},"locale not updated",2000).runs(function(){expect(e.text()).toBe("1.234,568")}).done();i.start()})});it("should keep already loaded locales at tmhDynamicLocaleCache",function(b){inject(function(f,e,g,d,c){var h=a(b);var j=jasmine.createSpy();var i=null;h.runs(function(){expect(d.info().size).toBe(0);g.set("es");expect(d.info().size).toBe(0)}).waitsFor(function(){f.flush(50);return e.id==="es"},"locale not updated",2000).runs(function(){expect(d.info().size).toBe(1);expect(d.get("es")).toEqual(e);i=angular.copy(e);g.set("it")}).waitsFor(function(){f.flush(50);return e.id==="it"},"locale not updated",2000).runs(function(){expect(d.info().size).toBe(2);expect(d.get("es")).toEqual(i);expect(d.get("it")).toEqual(e)}).done();h.start()})});it("should use the cache when possible",function(b){inject(function(f,e,g,d,c){var h=a(b);var i=jasmine.createSpy();h.runs(function(){g.set("es")}).waitsFor(function(){f.flush(50);return e.id==="es"},"locale not updated",2000).runs(function(){g.set("it")}).waitsFor(function(){f.flush(50);return e.id==="it"},"locale not updated",2000).runs(function(){d.get("es").DATETIME_FORMATS.DAY["0"]="Domingo";c.$on("$localeChangeSuccess",i);g.set("es");expect(i.calls.count()).toBe(0);expect(e.id).toBe("it");c.$apply();expect(e.id).toBe("es");expect(e.DATETIME_FORMATS.DAY["0"]).toBe("Domingo");expect(i.calls.count()).toBe(1)}).done();h.start()})});it("should do a deep copy of the locale elements",function(b){inject(function(f,e,g,d,c){var h=a(b);h.runs(function(){g.set("es")}).waitsFor(function(){f.flush(50);return e.id==="es"},"locale not updated",2000).runs(function(){e.DATETIME_FORMATS.DAY["0"]="XXX";expect(e.DATETIME_FORMATS.DAY["0"]).not.toBe(d.get("es").DATETIME_FORMATS.DAY["0"])}).done();h.start()})});it("should be able to handle locales with extra elements",function(b){inject(function(f,e,h,d,c){var i=a(b);var g;i.runs(function(){h.set("es")}).waitsFor(function(){f.flush(50);return e.id==="es"},"locale not updated",2000).runs(function(){g=angular.copy(e);g.id="xx";g.EXTRA_PARAMETER={foo:"FOO"};g.DATETIME_FORMATS.DAY["7"]="One More Day";d.put("xx",angular.copy(g));h.set("xx")}).waitsFor(function(){f.flush(50);return e.id==="xx"},"locale not updated",2000).runs(function(){expect(e).toEqual(g);expect(e.EXTRA_PARAMETER).toEqual({foo:"FOO"});h.set("es")}).waitsFor(function(){f.flush(50);return e.id==="es"},"locale not updated",2000).runs(function(){expect(e.EXTRA_PARAMETER).toBeUndefined();expect(e.DATETIME_FORMATS.DAY["7"]).toBeUndefined();expect(e.DATETIME_FORMATS.DAY.length).toBe(7)}).done();i.start()})});describe("having a default locale",function(){beforeEach(module(function(b){b.defaultLocale("it")}));it("should set the locale to the default locale",function(b){inject(function(e,d,c){var f=a(b);f.runs(function(){expect(d.id).toBe("en-us");c.$apply()}).waitsFor(function(){e.flush(50);return d.id==="it"},"locale not updated",2000).runs(function(){expect(d.id).toBe("it")}).done();f.start()})})});describe("having a cookie storage",function(){beforeEach(module("ngCookies"));beforeEach(module(function(b){b.useCookieStorage()}));it("should store the change on the cookie store",function(b){inject(function(d,c,g,e){var f=a(b);f.runs(function(){e.set("es");expect(g.get("tmhDynamicLocale.locale")).toBe(undefined)}).waitsFor(function(){d.flush(50);return c.id==="es"},"locale not updated",2000).runs(function(){expect(g.get("tmhDynamicLocale.locale")).toBe("es")}).done();f.start()})});describe("reading the locale at initialization",function(){beforeEach(inject(function(c,b){c.put("tmhDynamicLocale.locale","it");b.$apply()}));it("should load the locale on initialization",function(b){inject(function(e,d,c){var f=a(b);f.runs(function(){expect(d.id).toBe("en-us")}).waitsFor(function(){e.flush(50);return d.id==="it"},"locale not updated",2000).runs(function(){expect(d.id).toBe("it")}).done();f.start()})})});describe("and having a default language",function(){beforeEach(module(function(b){b.defaultLocale("es")}));beforeEach(inject(function(c,b){c.put("tmhDynamicLocale.locale","it");b.$apply()}));it("should load the locale on initialization",function(b){inject(function(e,d,c){var f=a(b);f.runs(function(){expect(d.id).toBe("en-us")}).waitsFor(function(){e.flush(50);return d.id==="it"},"locale not updated",2000).runs(function(){expect(d.id).toBe("it")}).done();f.start()})})});describe("and changing the name of the storageKey",function(){beforeEach(module(function(b){b.storageKey("customStorageKeyName")}));it("should change the name of the storageKey",function(b){inject(function(d,c,g,e){var f=a(b);f.runs(function(){e.set("es");expect(g.get("customStorageKeyName")).toBe(undefined);expect(g.get("tmhDynamicLocale.locale")).toBe(undefined)}).waitsFor(function(){d.flush(50);return c.id==="es"},"locale not updated",2000).runs(function(){expect(g.get("tmhDynamicLocale.locale")).toBe(undefined);expect(g.get("customStorageKeyName")).toBe("es")}).done();f.start()})})})});describe("loading locales using <script>",function(){function b(f,g){var e=0,c=f.getElementsByTagName("script");for(var d=0;d<c.length;++d){e+=(c[d].src==="http://localhost:9876/base/node_modules/angular-i18n/angular-locale_"+g+".js"?1:0)}return e}it("should load the locales using a <script> tag",function(c){inject(function(e,f,h,d){var g=a(c);g.runs(function(){f.set("fr");expect(b(h[0].body,"fr")).toBe(1)}).waitsFor(function(){e.flush(50);return d.id==="fr"},"locale not updated",2000).runs(function(){expect(b(h[0].body,"fr")).toBe(0)}).done();g.start()})});it("should load the locales in the custom tag (head) using a <script> tag",function(c){module(function(d){d.appendScriptTo(document.head)});inject(function(e,f,h,d){var g=a(c);g.runs(function(){f.set("fr");expect(b(h[0].head,"fr")).toBe(1)}).done();g.start()})});it("should not load the same locale twice",function(c){inject(function(f,g,d,i,e){var h=a(c);h.runs(function(){g.set("ja");g.set("ja");expect(b(i[0].body,"ja")).toBe(1)}).waitsFor(function(){f.flush(50);return e.id==="ja"},"locale not updated",2000).runs(function(){expect(b(i[0].body,"ja")).toBe(0);g.set("ja");expect(b(i[0].body,"ja")).toBe(0);g.set("et")}).waitsFor(function(){f.flush(50);return e.id==="et"},"locale not updated",2000).runs(function(){d.$apply(function(){g.set("ja");expect(b(i[0].body,"ja")).toBe(0)});expect(b(i[0].body,"ja")).toBe(0)}).done();h.start()})});it("should return a promise that is resolved when the script is loaded",function(c){inject(function(e,f,h,d){var g=a(c);var i=jasmine.createSpy();g.runs(function(){f.set("ko").then(i);f.set("ko").then(i);expect(i).not.toHaveBeenCalled()}).waitsFor(function(){e.flush(50);return d.id==="ko"},"locale not updated",2000).runs(function(){expect(i.calls.count()).toBe(2)}).done();g.start()})})});it("should be possible to add local properties to the locale location pattern",function(b){module(function(c){c.localeLocationPattern("/{{base}}/angular-locale_{{locale}}.js");c.addLocalePatternValue("base","base/node_modules/angular-i18n")});inject(function(c,d,e){var f=a(b);f.runs(function(){e.set("es")}).waitsFor(function(){d.flush(50);return c.id==="es"},"locale not updated",2000).runs(function(){expect(c.id).toBe("es");expect(c.DATETIME_FORMATS.DAY["0"]).toBe("domingo")}).done();f.start()})})})}());