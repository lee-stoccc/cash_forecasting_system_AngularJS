var nopt=require("nopt"),fs=require("fs"),Path=require("path"),glob=require("glob"),async=require("async"),MessageFormat=require("../"),knownOpts={locale:String,inputdir:Path,output:Path,watch:Boolean,namespace:String,include:String,stdout:Boolean,module:Boolean,verbose:Boolean,help:Boolean},description={locale:"locale(s) to use [mandatory]",inputdir:"directory containing messageformat files to compile",output:"output where messageformat will be compiled",namespace:"global object in the output containing the templates",include:"glob patterns for files to include from `inputdir`",stdout:"print the result in stdout instead of writing in a file",watch:"watch `inputdir` for changes",module:"create a commonJS module, instead of a global window variable",verbose:"print logs for debug"},defaults={inputdir:process.cwd(),output:process.cwd(),watch:false,namespace:"i18n",include:"**/*.json",stdout:false,verbose:false,module:false,help:false},shortHands={l:"--locale",i:"--inputdir",o:"--output",ns:"--namespace",I:"--include",m:"--module",s:"--stdout",w:"--watch",v:"--verbose","?":"--help"},options=(function(){var d=nopt(knownOpts,shortHands,process.argv,2);for(var a in defaults){d[a]=d[a]||defaults[a]}if(d.argv.remain){if(d.argv.remain.length>=1){d.inputdir=d.argv.remain[0]}if(d.argv.remain.length>=2){d.output=d.argv.remain[1]}}if(!d.locale||d.help){var b=["Usage: messageformat -l [locale] [OPTIONS] [INPUT_DIR] [OUTPUT_DIR]"];if(!d.help){b.push("Try 'messageformat --help' for more information.");console.error(b.join("\n"));process.exit(-1)}b.push("\nAvailable options:");for(var a in shortHands){var c=description[shortHands[a].toString().substr(2)];if(c){b.push("   -"+a+",\t"+shortHands[a]+(shortHands[a].length<8?"  ":"")+"\t"+c)}}console.log(b.join("\n"));process.exit(0)}if(fs.existsSync(d.output)&&fs.statSync(d.output).isDirectory()){d.output=Path.join(d.output,"i18n.js")}d.namespace=d.module?"module.exports":d.namespace.replace(/^window\./,"");return d})(),_log=(options.verbose?function(a){console.log(a)}:function(){});function write(a,b){if(a.stdout){_log("");return console.log(b)}fs.writeFile(a.output,b,"utf8",function(c){if(c){return console.error("--->\t"+c.message)}_log(a.output+" written.")})}function parseFileSync(a,d){var g=Path.join(a,d),e=d.split(/[.\/]+/),f={namespace:null,locale:null,data:null};if(!fs.statSync(g).isFile()){_log("Skipping "+d);return null}f.namespace=d.replace(/\.[^.]*$/,"").replace(/\\/g,"/");for(var c=e.length-1;c>=0;--c){if(e[c] in MessageFormat.plurals){f.locale=e[c];break}}try{_log("Building "+JSON.stringify(f.namespace)+" from `"+d+"` with "+(f.locale?"locale "+JSON.stringify(f.locale):"default locale"));f.data=JSON.parse(fs.readFileSync(g,"utf8"))}catch(b){console.error("--->\tRead error in "+g+": "+b.message)}return f}function build(a,f){var e=a.locale.trim().split(/[ ,]+/),c=new MessageFormat(e[0]),d={},b={global:a.namespace,locale:{}};e.slice(1).forEach(function(h){var g=c.runtime.pluralFuncs[h]=MessageFormat.plurals[h];if(!g){throw"Plural function for locale `"+h+"` not found"}});_log("Input dir: "+a.inputdir);_log("Included locales: "+e.join(", "));glob(a.include,{cwd:a.inputdir},function(h,g){if(!h){async.each(g,function(j,i){var k=parseFileSync(a.inputdir,j);if(k&&k.data){d[k.namespace]=k.data;if(k.locale){b.locale[k.namespace]=k.locale}}i()},function(){var j=c.compile(d,b).toString();j=j.replace(/^\s*function\b[^{]*{\s*/,"").replace(/\s*}\s*$/,"");var i=a.module?j:"(function(G) {\n"+j+"\n})(this);";return f(a,i.trim()+"\n")})}})}build(options,write);if(options.watch){_log("watching for changes in "+options.inputdir+"...\n");require("watchr").watch({path:options.inputdir,ignorePaths:[options.output],listener:function(a,b){if(/\.json$/.test(b)){build(options,write)}}})};