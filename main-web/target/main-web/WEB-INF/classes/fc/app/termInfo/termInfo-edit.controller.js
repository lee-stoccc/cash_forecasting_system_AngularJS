(function(){angular.module("devplatformApp").controller("TermInfoEditController",a);a.$inject=["$rootScope","TermInfoService","$scope","$stateParams","$state","ngDialog","PublicService","ngVerify","$uibModalInstance","$translate","SysDictService","FcPublicService","BankRuleService"];function a(j,x,o,w,v,n,i,h,p,r,u,b,q){o.dateList=i.getDateList();o.replenishRule=[{value:r.instant("bankRule.Monday"),key:1},{value:r.instant("bankRule.Tuesday"),key:2},{value:r.instant("bankRule.Wednesday"),key:3},{value:r.instant("bankRule.Thursday"),key:4},{value:r.instant("bankRule.Friday"),key:5},{value:r.instant("bankRule.Saturday"),key:6},{value:r.instant("bankRule.Sunday"),key:7}];o.workday=o.replenishRule.slice(0,5);o.formParam={id:"",termNo:"",cusTermNo:"",bankId:"",termType:"",region:"",cusRegionId:"",branchNo:"",address:"",commercial:"",status:"",forecastStatus:"",baseFirst:"1",holidayAdd:"1",replenishRule:"1,2,3,4,5",unitCount:500,lackRule:"0",day:1,time:1,indCashSecurity:0.99,indReplenishCost:2,escort:"",fullWarn:80,lackWarn:20,lackJudge:"0",fullJudge:"0",termCashLimits:"",replenishTimes:[{startTime:"08:00",endTime:"09:00"}],fixedAddDateList:[]};o.init=function(){o.language=r.storage().get("NG_TRANSLATE_LANG_KEY");s("termStatusList","forecast.termStatus");s("forecastStatusList","forecast.forecastStatus");o.formParam.fillUp="2";m();angular.element("#branch").select2({placeholder:r.instant("global.pleaseSelect"),allowClear:true,tags:false});console.log(o)};o.calcultePencent=function(){if(o.formParam.lackWarn>=100){o.formParam.lackWarn=99}if(o.formParam.lackWarn<=0){o.formParam.lackWarn=1}if(o.formParam.fullWarn>=100){o.formParam.fullWarn=99}if(o.formParam.fullWarn<=0){o.formParam.fullWarn=1}d(o.formParam.lackWarn,"lackWarn");d(o.formParam.fullWarn,"fullWarn")};o.select=function(y){angular.element(y).select2({placeholder:r.instant("global.pleaseSelect"),allowClear:true,tags:true})};o.changeCurrency=function(B,y){var z=true;var A="forecast.denomination."+B;u.getDictListAsync(A).then(function(D){if(D.statusCode==="0000"){var C=i.typeAndDemination2(D.data,B);o.formParam.termCashLimits.push({type:B,denominationList:C});if(o.formParam.termCashLimits.length==3){o.formParam.termCashLimits.shift()}}})};o.add=function(){o.formParam.termCashLimits.splice(o.formParam.termCashLimits.length+1,0,{denominationList:[],type:""})};o.del=function(y){if(o.formParam.termCashLimits.length===1){i.showDialogTimeout("global.del");return}o.formParam.termCashLimits.splice(y,1)};function d(z,y){if(z){angular.forEach(o.formParam.termCashLimits,function(A){angular.forEach(A.denominationList,function(B){if(B.minCeilingCount>B.fixCount){B.minCeilingCount=B.fixCount}B[y]=parseInt(B.fixCount*parseFloat(z/100,10))})})}}function s(z,y){u.getDictListAsync(y).then(function(A){if(A.statusCode==="0000"){o[z]=A.data}})}o.selectTermType=function(){var y=angular.element("#bankId").val();if(y){var z={id:y};o.bankSelectItem(z)}};o.changeBank=function(){o.select_all=false;o.select_workDay=false;o.flagChecked(o.replenishRule,false);q.getBankRule(o.formParam.bankId).then(function(y){if(y.statusCode==="0000"){o.formParam.baseFirst=y.data.baseFirst;o.formParam.indCashSecurity=1;o.formParam.indReplenishCost=y.data.indReplenishCost;o.formParam.replenishRule=y.data.replenishRule;o.formParam.holidayAdd=y.data.holidayAdd;o.formParam.day=y.data.day;o.formParam.time=y.data.time;o.formParam.unitCount=y.data.unitCount;o.formParam.lackRule=y.data.lackRule;g(y.data,["camFullWarn","camLackWarn","camFullJudge","camLackJudge","atmFullWarn","atmLackWarn","atmFullJudge","atmLackJudge","crsFullWarn","crsLackWarn","crsFullJudge","crsLackJudge","imFullWarn","imLackWarn","imFullJudge","imLackJudge"]);o.selectTermType();l()}})};function g(y,z){angular.forEach(z,function(A){o.formParam[A]=y[A]})}function t(B,A,z,y){o.formParam.fullWarn=o.formParam[B];o.formParam.lackWarn=o.formParam[A];o.formParam.lackJudge=o.formParam[z];o.formParam.fullJudge=o.formParam[y]}o.selectTermType=function(){if(o.formParam.termType&&o.formParam.bankId){switch(o.formParam.termType){case"1":t("camFullWarn","camLackWarn","camLackJudge","camFullJudge");break;case"2":t("atmFullWarn","atmLackWarn","atmLackJudge","atmFullJudge");break;case"3":t("crsFullWarn","crsLackWarn","crsLackJudge","crsFullJudge");break;default:t("imFullWarn","imLackWarn","imLackJudge","imFullJudge");break}}else{o.formParam.fullWarn=null;o.formParam.lackWarn=null;o.formParam.lackJudge=null;o.formParam.fullJudge=null}};o.changeNo=function(y){o.formParam.cusTermNo=y};function e(){b.getBanksList().then(function(y){if(y.statusCode==="0000"){o.bankList=y.data}})}function c(){b.getCusgionList().then(function(y){if(y.statusCode==="0000"){o.cusgionList=y.data}})}function m(){if(w.id){x.getTermInfo(w.id).then(function(y){if(y.statusCode==="0000"){o.formParam=y.data;l();o.calcultePencent()}})}}function l(){if(o.formParam.termCashLimits.length==0){o.formParam.termCashLimits=[{type:"",denominationList:[]}]}if(o.formParam.replenishTimes.length===0){o.formParam.replenishTimes=[{startTime:"",endTime:""}]}var D=[];if(o.formParam.replenishRule){angular.forEach(o.replenishRule,function(E){if(o.formParam.replenishRule.indexOf(E.key+"")>=0){D.push(E)}})}var A=i.showData(o.formParam.replenishRule,o.replenishRule);o.select_all=A.selectAll;o.select_workDay=A.selectWorkDay;if(D.length>0){o.flagChecked(D,true)}if(o.formParam.fixedAddDateList){angular.forEach(o.dateList,function(E){if(o.formParam.fixedAddDateList.indexOf(E.value)>=0){E.check=true}})}if(o.formParam.termCashLimits[0]["denominationList"].length==0||o.formParam.termCashLimits[1]["denominationList"].length==0){o.changeCurrency("HKD","0");o.changeCurrency("CNY","1")}else{var C=o.formParam.termCashLimits;for(var y=0;y<C.length;y++){if(C[y]["type"]=="CNY"){var z=o.formParam.termCashLimits[y]}else{var B=o.formParam.termCashLimits[y]}}o.formParam.termCashLimits[1]=i.typeAndDemination(z);o.formParam.termCashLimits[0]=i.typeAndDemination(B)}}o.addCashTime=function(){o.formParam.replenishTimes.splice(o.formParam.replenishTimes.length+1,0,{startTime:"",endTime:""})};o.delCashTime=function(y){if(o.formParam.replenishTimes.length===1){i.showDialogTimeout("termInfo.lastOne");return}o.formParam.replenishTimes.splice(y,1)};o.flagChecked=function(y,z){angular.forEach(y,function(A){A.checked=z})};o.selectAll=function(){if(o.select_all){o.select_workDay=false;o.flagChecked(o.replenishRule,true)}else{o.flagChecked(o.replenishRule,false)}};o.selectWorkDay=function(){o.flagChecked(o.replenishRule,false);if(o.select_workDay){o.select_all=false;o.flagChecked(o.workday,true)}else{o.flagChecked(o.workday,false)}};o.selectOne=function(){var y=i.calcWorkDayOrAll(o.replenishRule);o.select_workDay=y.selectWorkDay;o.select_all=y.selectAll};o.save=function(){k();var y=f();if(!y){i.showDialogTimeout("bankRule.selectOneCashTime");o.isSaving=true;return}o.isSaving=true;x.saveTermInfo(o.formParam).then(function(z){if(z.statusCode==="0000"){o.message="global.saveSuccess";i.showDialogTimeout(o.message);j.$broadcast("termInfoEdit","holiday");o.clear(false)}else{o.message=z.msgCode;i.openDialog(o.message);o.isSaving=false;o.clear(true)}})};function k(){o.formParam.fixedAddDateList=[];angular.forEach(o.dateList,function(y){if(y.check){o.formParam.fixedAddDateList.push(y.value)}})}function f(){var y=i.getCashDay(o.replenishRule);o.formParam.replenishRule=y.replenishRule;return y.flag}o.clear=function(y){p.close();v.go("app.termInfo",{},{reload:y})}}})();