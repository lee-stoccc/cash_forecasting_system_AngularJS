(function(){angular.module("devplatformApp").controller("BankRuleEditController",a);a.$inject=["$rootScope","FcPublicService","BankRuleService","$scope","$stateParams","$state","ngDialog","PublicService","$uibModalInstance","ngVerify","$translate","SysDictService"];function a(i,b,o,m,u,s,l,h,n,f,p,r){m.dateList=h.getDateList();m.replenishRule=[{value:p.instant("bankRule.Monday"),key:1},{value:p.instant("bankRule.Tuesday"),key:2},{value:p.instant("bankRule.Wednesday"),key:3},{value:p.instant("bankRule.Thursday"),key:4},{value:p.instant("bankRule.Friday"),key:5},{value:p.instant("bankRule.Saturday"),key:6},{value:p.instant("bankRule.Sunday"),key:7}];m.channelList=[{channelId:1,shortName:0.5},{channelId:2,shortName:0.55},{channelId:3,shortName:0.6},{channelId:4,shortName:0.65},{channelId:5,shortName:0.7}];m.workday=m.replenishRule.slice(0,5);m.amount=0;m.count=[];m.formParam={id:u.id,bankName:"",holidayAdd:"",replenishRule:"",unitCount:"",day:"",time:"",indCashSecurity:0.99,indReplenishCost:"",indCashReturn:"",camFullWarn:"",atmLackWarn:"",crsLackWarn:"",crsFullWarn:"",imLackWarn:"",imFullWarn:"",camFullJudge:"",atmLackJudge:"",crsLackJudge:"",crsFullJudge:"",imLackJudge:"",imFullJudge:"",volatilityDatum:"",multipleReplenish:"",fullImporttance:"",stockCeilings:[{type:"",denominationList:[]}],parentId:"",level:"",fixedAddDateList:[]};m.init=function(){q("deTypeList","forecast.denomination");if(u.id){c(u.id);m.$on("ngRepeatFinished",function(v){m.bankEdit.setValue(u.id)})}else{m.formParam.stockCeilings=[{type:"",denominationList:[]}]}m.changeCurrency("HKD","0");m.add();m.changeCurrency("CNY","1");d()};m.blurformParam=function(){if(m.formParam.indReplenishCost<1||m.formParam.indReplenishCost>3){m.formParam.indReplenishCost=null}};function q(w,v){r.getDictListAsync(v).then(function(x){if(x.statusCode==="0000"){m[w]=x.data}})}m.changeCurrency=function(w,v){m.getDenominationList(w,v)};m.getDenominationList=function(A,x){var y=false;if(m.formParam.stockCeilings.length>1){for(var w=0;w<m.formParam.stockCeilings.length;w++){if(x!=w){var v=m.formParam.stockCeilings[w];if(v.type===A){y=true;break}m.formParam.stockCeilings[w]["type"]="HKD"}else{m.formParam.stockCeilings[w]["type"]="CNY"}}}var z="forecast.denomination."+A+"";if(y){h.showDialogTimeout(A+"global.alreadyExisted");z="forecast.denomination."}r.getDictListAsync(z).then(function(B){if(B.statusCode==="0000"){angular.forEach(B.data,function(D){D.denomination=D.dictDesc;D.count=0});m.formParam.stockCeilings[x]["denominationList"]=B.data;if(m.formParam.stockCeilings[x]["denominationList"].length==1){m.formParam.stockCeilings[x]["denominationList"][0]["dictDescs"]="￥:"+m.formParam.stockCeilings[x]["denominationList"][0]["dictDesc"]}else{for(var C=0;C<m.formParam.stockCeilings[x]["denominationList"].length;C++){m.formParam.stockCeilings[x]["denominationList"][C]["dictDescs"]="HK$:"+m.formParam.stockCeilings[x]["denominationList"][C]["dictDesc"]}}}})};m.add=function(){if(m.formParam.stockCeilings.length>=m.deTypeList.length){h.showDialogTimeout("global.editDenomination");return}m.formParam.stockCeilings.splice(m.formParam.stockCeilings.length+1,0,{denominationList:[],type:""})};m.del=function(v){if(m.formParam.stockCeilings.length===1){h.showDialogTimeout("global.del");return}m.formParam.stockCeilings.splice(v,1)};m.changeMultipleReplenish=function(){h.showDialogTimeout("1")};m.changeVolatilityDatum=function(){h.showDialogTimeout("2")};m.changeFullImporttance=function(){h.showDialogTimeout("1")};m.calculteAmount=function(){m.amount=0;angular.forEach(m.formParam.stockCeilings,function(v){angular.forEach(v.denominationList,function(w){m.amount+=parseFloat(w.denomination,10)*w.count})})};function d(){m.showCheckBox=true;b.getBankTreeList().then(function(v){if(v.statusCode==="0000"){m.bankList=v.data}})}m.bankEditSelectCheck=function(v){};m.bankEditSelectItem=function(v){m.select_all=false;m.select_workDay=false;m.flagChecked(m.replenishRule,false);c(v.id)};function c(v){o.getBankRule(v).then(function(w){if(w.statusCode==="0000"){m.formParam=w.data;var z=w.data.stockCeilings;for(var y=0;y<z.length;y++){if(m.formParam.stockCeilings[y]["denominationList"].length==1){m.formParam.stockCeilings[y]["denominationList"][0]["dictDescs"]="￥:"+m.formParam.stockCeilings[y]["denominationList"][0]["denomination"]}else{for(var x=0;x<m.formParam.stockCeilings[y]["denominationList"].length;x++){m.formParam.stockCeilings[y]["denominationList"][x]["dictDescs"]="HK$:"+m.formParam.stockCeilings[y]["denominationList"][x]["denomination"]}}}m.formParam.stockCeilings.reverse();k(m.formParam)}})}function k(v){if(m.formParam.stockCeilings.length==0){m.formParam.stockCeilings=[{type:"",denominationList:[]}]}var x=[];angular.forEach(m.replenishRule,function(y){if(v.replenishRule){if(v.replenishRule.indexOf(y.key+"")>=0){x.push(y)}}});var w=h.showData(v.replenishRule,m.replenishRule);m.select_all=w.selectAll;m.select_workDay=w.selectWorkDay;if(x.length>0){m.flagChecked(x,true)}m.calculteAmount();m.formParam.fixedAddDateList=[];m.formParam.fixedAddDateList=m.formParam.fixedAddDate.split(",");if(m.formParam.fixedAddDateList){angular.forEach(m.dateList,function(y){if(m.formParam.fixedAddDateList.indexOf(y.value)>=0){y.check=true}})}}m.flagChecked=function(v,w){angular.forEach(v,function(x){x.checked=w})};m.selectAll=function(){if(m.select_all){m.select_workDay=false;m.flagChecked(m.replenishRule,true)}else{m.flagChecked(m.replenishRule,false)}};m.selectWorkDay=function(){m.flagChecked(m.replenishRule,false);if(m.select_workDay){m.select_all=false;m.flagChecked(m.workday,true)}else{m.flagChecked(m.workday,false)}};m.selectOne=function(){var v=h.calcWorkDayOrAll(m.replenishRule);m.select_workDay=v.selectWorkDay;m.select_all=v.selectAll};m.save=function(){var x=m.formParam;j();var w=e();var v=t();if(!w){h.showDialogTimeout("bankRule.selectOneCashTime");return}if(!v){h.showDialogTimeout("bankRule.selectOneBank");return}m.isSaving=true;o.saveBankRule(m.formParam).then(function(y){if(y.statusCode==="0000"){s.go("app.bankRule");var z="global.saveSuccess";h.showDialogTimeout(z);i.$broadcast("bankRuleEdit","holiday");m.clear(m.formParam,false)}else{m.message=y.msgCode;h.openDialog(m.message);m.isSaving=false}})};function j(){m.formParam.fixedAddDateList=[];angular.forEach(m.dateList,function(v){if(v.check){m.formParam.fixedAddDateList.push(v.value)}})}m.toTermInfoPage=function(v){var w={url:"app.termInfo",langSwitch:"menu.termInfo"};m.$parent.$parent.addContent(w)};function e(){var v=h.getCashDay(m.replenishRule);m.formParam.replenishRule=v.replenishRule;return v.flag}function t(){var v=true;var w=m.bankNoStr;if(h.isEmptyObject(w)){v=false}else{m.formParam.id=w.substring(0,w.length-1)}return v}m.clear=function(w,v){n.close();s.go("app.bankRule",w,{reload:v})};function g(){document.getElementsByClassName("modal-content")[0].style.marginTop="10px"}}})();