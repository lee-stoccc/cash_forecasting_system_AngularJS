(function(){angular.module("devplatformApp").controller("WarningInformationController",a);a.$inject=["$rootScope","$scope","ngDialog","LayoutService","$stateParams","$state","ngVerify","$translate","SysDictService"];function a(i,l,j,g,k,b,e,c,h){l.formParam={};l.init=function(){f("deTypeList","forecast.denomination");d();l.tablesConfig={checkOneAction:"checkOneAction",showCheckBox:false,isColspan:true,rowSpan:3,tableTitles:[{title:"warningInformation.networkName",filed:"bankName",type:"text",width:15},{title:"warningInformation.termNo",filed:"termNo",type:"text",width:10},{title:"warningInformation.realTimeBalance",dynamicTitles:l.colSpanData,filed:"detail",chridTitle:"amount",chridFiled:"count",type:"text",width:20},{title:"warningInformation.runningState",filed:"status",type:"text",width:10},{title:"warningInformation.monitoringTime",filed:"date",type:"date",width:10},{title:"entity.action.operation",filed:"operation",type:"btn",width:10,actions:[{actionName:"addCash(item)",name:"entity.action.add"}]}],url:"api/termWarn/page",formParams:{termNo:l.formParam.termNo,bankId:l.formParam.bankId,termType:l.formParam.termType,cusRegionId:l.formParam.cusRegionId,replenishDate:l.formParam.replenishDate,forecastStatus:"1"}}};function f(n,m){h.getDictListAsync(m).then(function(o){if(o.statusCode==="0000"){l[n]=o.data}})}l.colSpanData=[];function d(){for(var m=0;m<l.deTypeList.length;m++){var n=l.deTypeList[m].dictKey;var o="forecast.denomination."+n;h.getDictListAsync(o).then(function(p){if(p.statusCode==="0000"){var q={itemList:[],type:""};q.itemList=p.data;q.title=n;l.colSpanData[m]=q}})}l.colSpanData[0]["title"]=l.deTypeList[0].dictKey+"(HK$)";l.colSpanData[1]["title"]=l.deTypeList[1].dictKey+"(￥)"}l.loadAll=function(){l.refreshTableList(l.formParam)};i.$on("warningInformationEdit",function(m,n){l.loadAll()});l.addCash=function(m){j.open({template:"fc/app/warningInformation/warningInformation-edit.html",className:"ngdialog-theme-default",scope:l,controller:["$rootScope","ForecastPlanService","ngDialog","$stateParams","$state","$scope","PublicService","SysDictService",function(t,y,u,C,A,v,r,z){v.datePickerOpenStatus={};v.forecastPlan={date:m.date,termNo:m.termNo,detailList:[{currency:"",denominationList:"",amount:"",count:""}]};v.formParams={id:C.id,planId:C.planId};var D={};var n;v.typeAndDemination=[{denominationList:[],type:""}];v.init=function(){w("denominationList","forecast.denomination");w("deTypeList","forecast.denomination");o();var G=m.detail;v.cashCount=v.deminationCash(G);v.changeCurrency("HKD","0");v.add();v.changeCurrency("CNY","1");v.forecastPlan.replenishDate=dateToGMT(v.forecastPlan.date)};function w(H,G){z.getDictListAsync(G).then(function(I){if(I.statusCode==="0000"){v[H]=I.data;n=(I.data).length}})}function p(G){y.getFirstData(G).then(function(H){if(H.statusCode==="0000"){v.stockAmount=H.data.currentStock}})}v.changeCurrency=function(H,G){v.getDenominationList(H,G)};v.getDenominationList=function(I,G){var H="forecast.denomination."+I+"";if(E(I)&&B()>0){r.showDialogTimeout(I+"global.alreadyExisted");return}z.getDictListAsync(H).then(function(J){if(J.statusCode==="0000"){console.log(m);v.typeAndDemination[G]["denominationList"]=J.data;if(v.typeAndDemination[G]["denominationList"].length==1){v.typeAndDemination[G]["type"]="CNY";v.typeAndDemination[G]["denominationList"][0]["count"]=v.cashCount.CNY;v.typeAndDemination[G]["denominationList"][0]["dictDescs"]="￥:"+v.typeAndDemination[G]["denominationList"][0]["dictDesc"]}else{for(var K=0;K<v.typeAndDemination[G]["denominationList"].length;K++){v.typeAndDemination[G]["denominationList"][0]["count"]=v.cashCount.HKD100;v.typeAndDemination[G]["denominationList"][1]["count"]=v.cashCount.HKD500;v.typeAndDemination[G]["denominationList"][2]["count"]=v.cashCount.HKD1000;v.typeAndDemination[G]["type"]="HKD";v.typeAndDemination[G]["denominationList"][K]["dictDescs"]="HK$:"+v.typeAndDemination[G]["denominationList"][K]["dictDesc"]}}}});if(I!=""){F(G,I)}else{q(G)}};v.deminationCash=function(I){var G={};for(var H=0;H<I.length;H++){if(I[H].currency=="CNY"&&I[H].denomination==100){G.CNY=I[H]["count"]}else{if(I[H].denomination==1000&&I[H].currency=="HKD"){G.HKD1000=I[H].count}else{if(I[H].denomination==100&&I[H].currency=="HKD"){G.HKD100=I[H].count}else{if(I[H].denomination==500&&I[H].currency=="HKD"){G.HKD500=I[H].count}}}}}return G};v.add=function(){if(B()==0){r.showDialogTimeout("global.selectCurrency");return}if(v.typeAndDemination.length>=n){r.showDialogTimeout("global.editDenomination");return}v.typeAndDemination.splice(v.typeAndDemination.length+1,0,{denominationList:[],type:""})};v.del=function(G){if(v.typeAndDemination.length===1){r.showDialogTimeout("global.del");return}q(G);v.typeAndDemination.splice(G,1)};function F(I,G){var H=I;D[H]=G}function B(){var H=0;for(var G in D){H++}return H}function q(G){delete D[G]}function E(H){for(var G in D){if(H==D[G]){return true}}return false}function o(){angular.forEach(v.denominationList,function(G){var H={denomination:G.dictKey};v.forecastPlan.detailList.push(H)})}v.openCalendar=function(G){v.datePickerOpenStatus[G]=true};v.save=function(){x();v.forecastPlan.replenishDate=m.warnId;v.forecastPlan.replenishDate=m.date;v.forecastPlan.termNo=m.termNo;y.saveForecastPlan(v.forecastPlan).then(function(G){if(G.statusCode==="0000"){v.message="global.saveSuccess";r.openDialog(v.message);setTimeout(function H(){$(".ngdialog-theme-default").remove();$(".ngdialog-theme-default").remove()},2000);t.$broadcast("warningInformationEdit","")}})};v.checkDate=function(){if(v.forecastPlan.replenishDate.getDate()<new Date().getDate()){r.openDialog("global.timeMsg3");v.forecastPlan.replenishDate=null}};function x(){var G=new Array();console.log(v);for(var H=0;H<v.typeAndDemination.length;H++){var N=v.typeAndDemination[H].type;var O=v.typeAndDemination[H].denominationList;for(var J=0;J<O.length;J++){var I=Number(O[J].dictKey);var M=Number(O[J].count);var L=I*M;var K={denomination:I,currency:N,count:M,amount:L};G.push(K)}}if(G.length>0){v.forecastPlan.detailList=G}}v.clear=function(){$(".ngdialog-theme-default").remove()};function s(){var H=0;for(var G=0;G<v.forecastPlan.detailList.length;G++){if(v.forecastPlan.detailList[G].count){H+=v.forecastPlan.detailList[G].denomination*v.forecastPlan.detailList[G].count}else{continue}}if(H>v.stockAmount){return false}return true}}]})}}})();