(function(){angular.module("devplatformApp").controller("ForecastPlanController",a);a.$inject=["$rootScope","FcPublicService","SysDictService","ForecastPlanService","ngDialog","$state","$scope","$timeout","PublicService","$uibModal","$translate"];function a(l,q,k,n,m,b,o,f,i,h,c){o.formParam={};o.formParam.replenishDate=new Date();o.datePickerOpenStatus={};o.dateOptions={showWeeks:false,formatDayHeader:"EEE"};o.init=function(){g("deTypeList","forecast.denomination");e();p();o.tablesConfig={showCheckBox:true,isColspan:true,checkOneAction:"checkOneAction",checkAllAction:"checkAllAction",rowSpan:3,tableTitles:[{title:"forecastPlan.termNo",filed:"termNo",type:"text",width:8,tipTitle:"Terminal ID"},{title:"forecastPlan.branchNo",filed:"branchNo",type:"text",width:8,tipTitle:"Branch Code"},{title:"forecastPlan.bankName",filed:"bankName",type:"text",width:15,tipTitle:"Brank Name"},{title:"forecastPlan.regionName",filed:"regionName",type:"text",width:10,tipTitle:"District"},{title:"forecastPlan.replenishDate",filed:"replenishDate",type:"date",width:10,tipTitle:"Replenish Date"},{title:"forecastPlan.escort",filed:"escort",type:"text",width:10,tipTitle:"Escort"},{title:"forecastPlan.planCash",dynamicTitles:o.colSpanData,filed:"planDetails",chridTitle:"dictDesc",chridFiled:"count",type:"text",width:18},],url:"api/forecastPlan/page",formParams:{termNo:o.formParam.termNo,bankId:o.formParam.bankId,termType:o.formParam.termType,cusRegionId:o.formParam.cusRegionId,replenishDate:o.formParam.replenishDate,forecastStatus:"1"}};o.select("#regionNamePlan");o.select("#termTypePlan");o.select("#bankNamePlan");o.select("#bankName")};o.select=function(r){angular.element(r).select2({placeholder:c.instant("global.pleaseSelect"),allowClear:true,tags:false})};o.checkOneAction=function(r){d(r)};o.checkAllAction=function(r){d(r)};o.colSpanData=[];function e(){for(var r=0;r<o.deTypeList.length;r++){var s=o.deTypeList[r].dictKey;var t="forecast.denomination."+s;k.getDictListAsync(t).then(function(u){if(u.statusCode==="0000"){var v={itemList:[],type:""};v.itemList=u.data;v.title=s;o.colSpanData[r]=v}})}o.colSpanData[0]["title"]=o.deTypeList[0].dictKey+"(HK$)";o.colSpanData[1]["title"]=o.deTypeList[1].dictKey+"(ï¿¥)"}function d(r){o.item=[""];o.data=[[0],[0]];if(r.length==0){return}angular.forEach(r,function(v){if(v.checked){if(v.forecastList==null||v.forecastList.length==0){return}for(var u=0;u<v.forecastList.length;u++){var s=v.forecastList[u];var t=i.formatDate(s.replenishDate,"yyyy-MM-dd");if(o.item.length<=u){o.item[u]=t;o.data[0][u]=0;o.data[1][u]=0}o.data[0][u]+=s.usingAmount;o.data[1][u]+=s.replenishAmount}}});o.refreshEchart("echart",{item:o.item,legend:o.legend,data:o.data})}o.legend=["Predicted daily consumption","Predict the full amount of the bill"];o.item=[""];o.data=[[0],[0]];o.echartData={title:"Daily Prelog",id:"echart",width:"600px",height:"450px",legend:o.legend,item:o.item,data:o.data};o.$on("noPlanLoad",function(r,s){o.loadNoPlanAll=s});o.loadAll=function(){o.refreshTableList(o.formParam);o.loadNoPlanAll()};o.resetSearch=function(){o.formParam={};o.bankIdStr="";o.bankId=[];o.bankName=""};o.addForecastPlan=function(r){o.choseArr=o.getCheckObjects();if(o.choseArr.length!=1){var s="global.chooseOneEdit";i.openDialog(s);return}else{if(r==="1"){b.go("app.forecastPlan-edit",{id:o.choseArr[0].id,planId:o.choseArr[0].planId,termNo:o.choseArr[0].termNo,bankId:o.choseArr[0].bankId})}else{b.go("app.forecastPlan-edit",{id:o.choseArr[0].id,planId:"",termNo:o.choseArr[0].termNo,bankId:o.choseArr[0].bankId})}}};o.stockManage=function(){b.go("app.stock")};o.forecast=function(){var r=o.formParam.replenishDate;var s=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds();n.downLoadFile(s)};o.getPlanId=function(){var s=[];for(var r=0;r<o.tableList.length;r++){if(o.tableList[r].checked===true){if(o.tableList[r].planId==null){continue}else{s.push(o.tableList[r].planId)}}}return s};o.openCalendar=function(r){o.datePickerOpenStatus[r]=true};o.batchDelete=function(){o.choseArr=o.getCheckValues("delFlag").check;o.chosePlanId=o.getPlanId();var r="";if(i.isEmptyObject(o.choseArr[0])){r="global.selectDelete";i.openDialog(r);return}if(o.chosePlanId.length===0){r="global.noPlanId";i.openDialog(r);return}r="global.messages.deleteConfirm";i.showConfirmDialog(r,"confirmDelete",o,o.chosePlanId)};o.confirmDelete=function(r){n.deleteForecastPlan(r).then(function(s){if(s.statusCode==="0000"){o.loadAll();var t="global.messages.deleteSuccess";i.openDialog(t)}})};function p(){o.showCheckBox=true;q.getBanksList().then(function(r){if(r.statusCode==="0000"){o.bankList=r.data}})}o.bankForecastSelectItem=function(r){};o.bankForecastSelectCheck=function(r){};function j(){n.getCusgionList().then(function(r){if(r.statusCode==="0000"){o.cusgionList=r.data}})}function g(s,r){k.getDictListAsync(r).then(function(t){if(t.statusCode==="0000"){o[s]=t.data}})}o.noPlanShow=function(){if($(".noPlanDiv").hasClass("plan-show")){$(".noPlanDiv").removeClass("plan-show")}else{$(".noPlanDiv").addClass("plan-show")}};o.goEchartShow=function(){var r={url:"app.forecastReportform",langSwitch:"menu.forecastReportform"};o.$parent.$parent.addContent(r)};o.echartShow=function(){if($(".forecastEchart").hasClass("plan-show")){$(".forecastEchart").removeClass("plan-show")}else{$(".forecastEchart").addClass("plan-show")}};l.$on("forecastPlanEdit",function(r,s){o.loadAll()});o.createPlan=function(){b.go("app.createPlan")};o.createPlan2=function(){n.createPlan2().then(function(r){if(r.statusCode==="0000"){var s="global.messages.forecastSuccess";i.showDialogTimeout(s);o.refreshTableList(o.formParam)}else{var s="global.messages.forecastFail";i.showDialogTimeout(s)}})}}})();